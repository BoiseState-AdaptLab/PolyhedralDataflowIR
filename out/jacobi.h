// 'jacobi' code generated by 'edavis' at 07/08/2019 10:14:54
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <math.h>

#define min(x,y) (((x)<(y))?(x):(y))
#define max(x,y) (((x)>(y))?(x):(y))
#define abs(x) ((x)<0?-(x):(x))
#define absmin(x,y) ((x)=min(abs((x)),abs((y))))
#define absmax(x,y) ((x)=max(abs((x)),abs((y))))
#define floord(x,y) ((x)/(y))
#define sgn(x) ((x)<0?-1:1)
#define offset2(i,j,M) ((j)+(i)*(M))
#define offset3(i,j,k,M,N) ((k)+((j)+(i)*(M))*(N))
#define offset4(i,j,k,l,M,N,P) ((l)+((k)+((j)+(i)*(M))*(N))*(P))
#define arrinit(ptr,val,size) for(unsigned __i__=0;__i__<(size);__i__++) (ptr)[__i__]=(val)
#define arrprnt(name,arr,size) {\
fprintf(stderr,"%s={",(name));\
for(unsigned __i__=0;__i__<(size);__i__++) fprintf(stderr,"%lg,",(arr)[__i__]);\
fprintf(stderr,"}\n");}
#define b(i) b[(i)]
#define x(t,i) x[((t)&1)*N+(i)]
#define A(i,j) A[offset2((i),(j),(N))]

double* jacobi(const double tol, const double* A, const double* b, const unsigned N, const unsigned T);
inline double* jacobi(const double tol, const double* A, const double* b, const unsigned N, const unsigned T) {
    unsigned t1,t2,t3,t4,t5;
    double err = 0;
    double* x = (double*) calloc(2*(N),sizeof(double));

// clear+init+dot+div+norm+check
#undef s0
#define s0(t) err=0.000000
#undef s1
#define s1(t,i) x((t),(i))=b((i))
#undef s2
#define s2(t,i,j) x((t),(i))+=(-A((i),(j)))*x((t)-1,(j))
#undef s3
#define s3(t,i) x((t),(i))/=A((i),(i))
#undef s4
#define s4(t,i) err+=(x((t),(i))-x((t)-1,(i)))*x((t),(i))-x((t)-1,(i))
#undef s5
#define s5(t) if (sqrt(err) <= tol) (t)=T+1

#pragma omp parallel for schedule(auto) private(t2,t4,t5)
for(t1 = 1; t1 <= T; t1++) {
    s0(t1);
    for(t3 = 0; t3 <= N-1; t3++) {
        s1(t1,t3);
        for(t5 = 0; t5 <= t3-1; t5++) {
            s2(t1,t3,t5);
        }
        for(t5 = t3+1; t5 <= N-1; t5++) {
            s2(t1,t3,t5);
        }
        s3(t1,t3);
        s4(t1,t3);
    }
    s5(t1);
}

    return (x);
}    // jacobi

#undef min
#undef max
#undef abs
#undef absmin
#undef absmax
#undef floord
#undef sgn
#undef offset2
#undef offset3
#undef offset4
#undef arrinit
#undef arrprnt
#undef b
#undef x
#undef A

